# DebtCrasher 프로젝트 개발 문서

DebtCrasher는 개발 과정의 모든 맥락(Context)을 캡처하여 개발 부채를 관리하고 히스토리를 시각화하는 VS Code 확장 프로그램입니다. **"기록은 구조적으로(Layer A), 보고는 서사적으로(Layer B)"**라는 철학을 따릅니다.

## 1. 프로젝트 아키텍처

이 프로젝트는 명확한 **2-Layer 아키텍처**를 따릅니다.

### Layer A: 구조적 로그 (Structured Log Layer)
- **책임**: "있는 그대로의 사실"을 기록합니다.
- **저장소**: `.devcrasher/logs/YYYY-MM-DD-N.log` (JSON Lines 형식)
- **데이터**: 
  - **Auto**: `file_save` (Diff, 추가/삭제 라인 수)
  - **Manual**: `decision`, `bugfix` (사용자 메모)
  - **AI**: `ai_note` (AI가 분석한 코드 변경 의도, 요약, 리스크)

### Layer B: 서사적 리포트 (Narrative Report Layer)
- **책임**: Layer A의 데이터를 "읽기 좋은 이야기"로 재구성합니다.
- **출력**: `.devcrasher/reports/report.md` (Markdown) & VS Code Webview.
- **철학**: "Notion처럼 깔끔하게, 한글로 친절하게"

---

## 2. 주요 기능 및 워크플로우

### 2.1 자동 로깅 (Auto Logging)
- 파일 저장 시(`onDidSaveTextDocument`) 메모리 캐시와 비교하여 `diff`를 계산하고 즉시 저장합니다.
- `.git` 폴더 등 불필요한 변경은 자동으로 무시됩니다.

### 2.2 AI 노트 생성 (AI Note Generation)
- **핵심**: "이 코드가 왜 바뀌었는가?"를 AI가 대신 작성합니다.
- **트리거**: 저장 시 자동 실행(설정 가능) 또는 수동 명령.
- **모델 전략**: 
  - 노트 생성은 빈번하므로 가볍고 저렴한 모델(`gpt-4o-mini`, `gemini-1.5-flash`) 사용을 권장.
- **출력**: 작업 유형(Feature/Refactor..), 목적, 요약, 주요 변경 함수 등을 구조화된 데이터로 저장.

### 2.3 리포트 & 시각화
- Markdown으로 변환된 리포트를 VS Code Webview에서 렌더링합니다.
- **UI**: Notion 스타일 CSS 적용, 이모지(✨, 🐛) 활용.
- **PDF**: 브라우저 기본 인쇄 기능을 활용하여 PDF로 저장 가능.

---

## 3. 코드베이스 구조 (`src/`)

| 파일 | 역할 및 핵심 로직 |
| :--- | :--- |
| **`extension.ts`** | **진입점**. 명령어 등록, 이벤트 리스너(저장 감지) 연결, 설정 로드. |
| **`logging.ts`** | **Layer A**. 파일 시스템 I/O, Diff 알고리즘, 세션 관리. |
| **`aiClient.ts`** | **AI 클라이언트**. Provider(OpenAI/Gemini/DeepSeek) 연동, 프롬프트 관리. |
| **`report.ts`** | **Layer B**. 요약 리포트 생성(Markdown 변환), 한글화/포맷팅 담당. |
| **`webview.ts`** | **뷰어**. 생성된 리포트를 표시하는 Webview 패널 및 CSS/Script 주입. |

---

## 4. 설정 (Configuration)

설정은 **"API Key 중앙화"**와 **"목적별 모델 분리"**를 통해 효율성을 극대화했습니다.

### 4.1 Provider 설정 (API Key)
키는 한 번만 입력하면 모든 기능에서 공유됩니다.
- `debtcrasher.providers.openai.apiKey`
- `debtcrasher.providers.gemini.apiKey`
- `debtcrasher.providers.deepseek.apiKey`

### 4.2 목적별 모델 선택
- **AI Note**: 자주 실행되므로 속도/비용 최적화 모델 선택.
  - `debtcrasher.note.provider`: (예: `openai`)
  - `debtcrasher.note.model`: (예: `gpt-4o-mini`)
- **Report**: (향후 확장) 고품질 요약을 위한 고성능 모델 선택.
  - `debtcrasher.report.provider`: (예: `openai`)
  - `debtcrasher.report.model`: (예: `gpt-4o`)

---

## 5. 데이터 스키마 (`ai_note`)

```typescript
// AI Note 이벤트 구조 (JSON Log)
{
  "type": "ai_note",
  "workType": "feature" | "refactor" | "bugfix" | "test" | "chore",
  "mainGoal": "로그인 페이지 유효성 검사 로직 개선",
  "changeSummary": "이메일 정규식 패턴을 강화하고 에러 메시지를 상수화함.",
  "importantFunctions": ["validateEmail", "showErrorToast"],
  "risks": "기존 가입자의 이메일 포맷과 호환성 체크 필요",
  "nextSteps": "비밀번호 복잡도 검사 추가 예정"
}
```

---
*Generated by DebtCrasher Agent*

### AI 노트 이벤트 (`ai_note`)
AI가 생성한 분석 결과가 담기는 핵심 이벤트입니다.

```typescript
interface AiNoteEvent extends BaseEvent {
  type: 'ai_note';
  
  // 작업 유형
  workType: 'feature' | 'refactor' | 'bugfix' | 'test' | 'chore';
  
  // 핵심 목적 (한 줄 요약)
  mainGoal: string;
  
  // 변경 사항 상세 요약
  changeSummary: string;
  
  // 주요 변경 함수/메서드 목록
  importantFunctions: string[];
  
  // (Optional) 잠재적 리스크
  risks?: string;
  
  // (Optional) 다음 작업 제안
  nextSteps?: string;
}
```
